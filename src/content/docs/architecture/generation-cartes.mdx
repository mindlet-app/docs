---
title: G√©n√©ration de cartes
description: Architecture agentic du Card Generator Graph pour la cr√©ation de cartes d'apprentissage
sidebar:
  order: 7
---

import { Aside, Badge, Card, CardGrid, Steps, TabItem, Tabs, FileTree } from '@astrojs/starlight/components';

# üé¥ G√©n√©ration de cartes

<Badge text="Agentic" variant="success" />
<Badge text="Mistral AI" variant="note" />
<Badge text="Multi-types" variant="caution" />

Le **Card Generator Graph** est un graphe **agentic** sophistiqu√© pour la g√©n√©ration intelligente de cartes d'apprentissage √† partir des chunks embedd√©s.

## Vue d'ensemble

Le syst√®me utilise une approche **agentic** avec plusieurs agents sp√©cialis√©s qui collaborent :

- **Planner** : Analyse le contenu et planifie la strat√©gie de g√©n√©ration
- **Generator** : Cr√©e les cartes selon le plan
- **Critic** : √âvalue la qualit√© et la diversit√©
- **Refiner** : Am√©liore les cartes selon le feedback
- **Finalizer** : G√©n√®re les m√©tadonn√©es et valide la collection

<Aside type="note">
  L'approche agentic permet au syst√®me de s'auto-corriger et d'optimiser la qualit√© des cartes g√©n√©r√©es de mani√®re it√©rative.
</Aside>

## Diagramme du Card Generator Graph

```mermaid
graph TD;
    __start__([__start__]):::first
    validate_inputs(validate_inputs)
    select_chunks(select_chunks)
    planner(planner)
    generator(generator)
    critic(critic)
    refiner(refiner)
    finalizer(finalizer)
    __end__([__end__]):::last
    
    __start__ --> validate_inputs;
    validate_inputs -. end .-> __end__;
    validate_inputs -.-> select_chunks;
    select_chunks --> planner;
    planner --> generator;
    generator --> critic;
    critic -.-> finalizer;
    critic -.-> generator;
    critic -.-> refiner;
    refiner -.-> finalizer;
    refiner -.-> generator;
    finalizer --> __end__;
    
    classDef default fill:#f2f0ff,line-height:1.2
    classDef first fill-opacity:0
    classDef last fill:#bfb6fc
```

## Architecture agentic d√©taill√©e

```mermaid
flowchart TB
    subgraph AGENT["ü§ñ CARD GENERATION AGENT<br/>(mistral-medium-latest)"]
        direction TB
        
        PLANNER["üéØ PLANNER<br/>Analyse le contenu<br/>Planifie la strat√©gie"]
        
        subgraph LOOP["üîÑ Boucle d'am√©lioration"]
            direction LR
            GENERATOR["‚ö° GENERATOR<br/>Cr√©e les cartes"]
            CRITIC["üîç CRITIC<br/>√âvalue qualit√©<br/>& diversit√©"]
            REFINER["‚ú® REFINER<br/>Am√©liore<br/>les cartes"]
        end
        
        COLLECTION["üìö CARD COLLECTION"]
        FINALIZER["üìã FINALIZER<br/>G√©n√®re metadata<br/>V√©rifie compl√©tude"]
    end
    
    PLANNER --> GENERATOR
    GENERATOR --> CRITIC
    CRITIC -->|"Besoin d'am√©lioration"| REFINER
    REFINER -->|"Re-g√©n√©ration"| GENERATOR
    CRITIC -->|"Cartes valid√©es"| COLLECTION
    REFINER -->|"Cartes am√©lior√©es"| COLLECTION
    COLLECTION --> FINALIZER
    
    style AGENT fill:#f5f5f5,stroke:#333,stroke-width:2px
    style PLANNER fill:#e3f2fd,stroke:#1976d2
    style GENERATOR fill:#fff3e0,stroke:#f57c00
    style CRITIC fill:#fce4ec,stroke:#c2185b
    style REFINER fill:#e8f5e9,stroke:#388e3c
    style COLLECTION fill:#f3e5f5,stroke:#7b1fa2
    style FINALIZER fill:#e0f7fa,stroke:#0097a7
    style LOOP fill:#fafafa,stroke:#9e9e9e,stroke-dasharray: 5 5
```

---

## Types de cartes support√©s

Le syst√®me peut g√©n√©rer **9 types de cartes** diff√©rents :

```python
class CardType(str, Enum):
    """Types de cartes disponibles pour la g√©n√©ration"""
    FLASHCARD = "flashcard"          # Question/R√©ponse classique
    MCQ = "mcq"                      # QCM (Questions √† Choix Multiples)
    FREE_TEXT = "free_text"          # R√©ponse libre
    TRUE_OR_FALSE = "true_or_false"  # Vrai ou Faux
    MATCH_PAIR = "match_pair"        # Correspondance
    SLIDER = "slider"                # Curseur num√©rique
    DRAG_AND_DROP = "drag_and_drop"  # Glisser-d√©poser
    RANKING = "ranking"              # Classement
    GEO_GUESS = "geo_guess"          # G√©olocalisation
```

<CardGrid>
  <Card title="Flashcard" icon="document">
    Question/r√©ponse simple pour la m√©morisation rapide.
  </Card>
  <Card title="QCM" icon="list-format">
    Question √† choix multiples avec distracteurs intelligents.
  </Card>
  <Card title="Vrai/Faux" icon="approve-check">
    Affirmation √† valider avec explication d√©taill√©e.
  </Card>
  <Card title="Match Pair" icon="puzzle">
    Relier des √©l√©ments correspondants entre eux.
  </Card>
  <Card title="Texte libre" icon="pencil">
    R√©ponse ouverte pour approfondir la compr√©hension.
  </Card>
  <Card title="Classement" icon="list-format">
    Ordonner des √©l√©ments selon un crit√®re donn√©.
  </Card>
</CardGrid>

---

## Workflow de g√©n√©ration

<Steps>
1. **Validation des inputs**
   - V√©rification des chunks embedd√©s
   - Validation des types de cartes demand√©s
   - V√©rification du nombre de cartes souhait√©

2. **S√©lection des chunks**
   - Algorithme K-means pour diversit√©
   - S√©lection des chunks les plus repr√©sentatifs
   - √âquilibrage du contenu

3. **Planification (Planner)**
   - Analyse du contenu des chunks
   - R√©partition des types de cartes
   - Strat√©gie de couverture du sujet

4. **G√©n√©ration (Generator)**
   - Cr√©ation des cartes selon le plan
   - Respect des formats par type
   - G√©n√©ration des distracteurs (QCM)

5. **√âvaluation (Critic)**
   - Score de qualit√© par carte
   - D√©tection des doublons
   - V√©rification de la diversit√©

6. **Raffinement (Refiner)**
   - Am√©lioration des cartes faibles
   - Suppression des doublons
   - Ajustement du niveau de difficult√©

7. **Finalisation**
   - G√©n√©ration des m√©tadonn√©es
   - Calcul des statistiques
   - Validation finale de la collection
</Steps>

---

## Agents du syst√®me

### Planner Agent

Le Planner analyse le contenu et cr√©e un plan de g√©n√©ration :

```python
class GenerationPlan(BaseModel):
    """Plan de g√©n√©ration des cartes"""
    card_distribution: Dict[CardType, int]  # R√©partition par type
    focus_topics: List[str]                  # Sujets prioritaires
    difficulty_curve: List[int]              # Progression difficult√©
    reasoning: str                           # Explication du plan
```

### Generator Agent

Le Generator cr√©e les cartes selon le plan :

<Tabs>
  <TabItem label="Flashcard">
    ```python
    {
        "type": "flashcard",
        "question": "Qu'est-ce que la photosynth√®se ?",
        "answer": "La photosynth√®se est le processus par lequel...",
        "difficulty": 2,
        "tags": ["biologie", "plantes"]
    }
    ```
  </TabItem>
  
  <TabItem label="QCM">
    ```python
    {
        "type": "mcq",
        "question": "Quel organite r√©alise la photosynth√®se ?",
        "correct_answer": "Chloroplaste",
        "options": [
            "Chloroplaste",
            "Mitochondrie",
            "Ribosome",
            "Noyau"
        ],
        "explanation": "Les chloroplastes contiennent...",
        "difficulty": 3
    }
    ```
  </TabItem>
  
  <TabItem label="Vrai/Faux">
    ```python
    {
        "type": "true_or_false",
        "statement": "La photosynth√®se produit de l'oxyg√®ne.",
        "is_true": True,
        "explanation": "La photosynth√®se lib√®re de l'O2...",
        "difficulty": 1
    }
    ```
  </TabItem>
</Tabs>

### Critic Agent

Le Critic √©value chaque carte selon plusieurs crit√®res :

```python
class CardQualityScore(BaseModel):
    """Score de qualit√© d'une carte"""
    clarity: float         # Clart√© de la question (0-1)
    relevance: float       # Pertinence p√©dagogique (0-1)
    difficulty_fit: float  # Ad√©quation difficult√© (0-1)
    uniqueness: float      # Originalit√© vs doublons (0-1)
    overall: float         # Score global (0-10)
    suggestions: List[str] # Suggestions d'am√©lioration
```

**Seuils de qualit√© :**

| Crit√®re | Seuil |
|---------|-------|
| Score minimum pour approbation | **7.5/10** |
| Seuil de similarit√© (doublons) | **75%** |
| Max tentatives de raffinement | **2** |

### Refiner Agent

Le Refiner am√©liore les cartes selon le feedback du Critic :

```mermaid
graph LR
    A[Carte originale] --> B{Score < 7.5?}
    B -->|Non| C[Approuv√©e]
    B -->|Oui| D[Refiner]
    D --> E{Tentative < 2?}
    E -->|Oui| F[Carte am√©lior√©e]
    F --> G[Re-√©valuation]
    E -->|Non| H[Rejet√©e]
    
    style C fill:#c8e6c9
    style H fill:#ffcdd2
```

---

## Types Agent

### Actions de l'Agent

```python
class AgentActionType(str, Enum):
    """Types d'actions disponibles pour l'agent"""
    GENERATE = "generate"        # G√©n√©rer de nouvelles cartes
    EVALUATE = "evaluate"        # √âvaluer les cartes existantes
    REFINE = "refine"           # Am√©liorer une carte
    REMOVE_DUPLICATE = "remove"  # Supprimer un doublon
    FINALIZE = "finalize"       # Finaliser la collection
```

### D√©cisions de l'Agent

```python
class AgentDecision(str, Enum):
    """D√©cisions possibles apr√®s √©valuation"""
    APPROVE = "approve"          # Carte approuv√©e
    REFINE = "refine"           # N√©cessite am√©lioration
    REGENERATE = "regenerate"   # Reg√©n√©rer compl√®tement
    REJECT = "reject"           # Rejeter la carte
    FINISH = "finish"           # Terminer la g√©n√©ration
```

### R√©sultat du Critic

```python
class CritiqueResult(BaseModel):
    """R√©sultat de l'√©valuation par le Critic"""
    cards_approved: List[str]        # IDs des cartes approuv√©es
    cards_to_refine: List[str]       # IDs √† am√©liorer
    cards_to_reject: List[str]       # IDs √† rejeter
    duplicate_pairs: List[Tuple]     # Paires de doublons
    diversity_score: float           # Score de diversit√©
    needs_more_generation: bool      # Si plus de cartes n√©cessaires
```

---

## Optimisation des batches

Le module `batch_optimizer.py` calcule dynamiquement la taille des batches pour optimiser les appels LLM :

```python
@dataclass(frozen=True)
class BatchConfig:
    """Configuration de batch optimis√©e"""
    batch_size: int              # Nombre de cartes par batch
    estimated_input_tokens: int  # Tokens d'entr√©e estim√©s
    estimated_output_tokens: int # Tokens de sortie estim√©s
    total_batches: int           # Nombre total de batches
```

### Estimation des tokens par type

| Type de carte | Tokens output estim√©s |
|---------------|----------------------|
| Flashcard | 150 |
| QCM | 250 |
| Vrai/Faux | 120 |
| Match Pair | 200 |
| Texte libre | 180 |
| Classement | 220 |
| Drag & Drop | 280 |
| Slider | 100 |
| Geo Guess | 150 |

---

## Exemple d'utilisation

```python
from src.graphs.card_generator import card_generator_graph
from src.models.card_types import CardType, CardTypeRequest

# Configuration des types de cartes souhait√©s
card_requests = [
    CardTypeRequest(card_type=CardType.FLASHCARD, count=5),
    CardTypeRequest(card_type=CardType.MCQ, count=3),
    CardTypeRequest(card_type=CardType.TRUE_OR_FALSE, count=2)
]

# Invocation du graphe
result = await card_generator_graph.ainvoke({
    "embedded_chunks": embedded_chunks,  # Depuis le graphe d'embedding
    "card_type_requests": card_requests,
    "language": "fr",
    "user_context": "Sujet: Biologie - La photosynth√®se"
})

# R√©cup√©ration des r√©sultats
generated_cards = result["generated_cards"]
metadata = result["collection_metadata"]

print(f"Cartes g√©n√©r√©es: {len(generated_cards)}")
print(f"Score moyen: {metadata['average_quality_score']}")
```

---

## Prompts YAML

Les prompts des agents sont stock√©s dans `src/prompts/` au format YAML avec support multi-langue :

```yaml
# src/prompts/generator.yaml
system:
  fr: |
    Tu es un expert en cr√©ation de contenu p√©dagogique.
    Tu g√©n√®res des cartes d'apprentissage de haute qualit√©.
    
  en: |
    You are an expert in educational content creation.
    You generate high-quality learning cards.

user:
  fr: |
    G√©n√®re {count} cartes de type {card_type} √† partir du contenu suivant:
    {content}
    
    Niveau de difficult√©: {difficulty}
```

### Prompts disponibles

| Fichier | Agent | R√¥le |
|---------|-------|------|
| `planner.yaml` | Planner | Planification de la g√©n√©ration |
| `generator.yaml` | Generator | Cr√©ation des cartes |
| `critic.yaml` | Critic | √âvaluation de qualit√© |
| `refiner.yaml` | Refiner | Am√©lioration des cartes |

---

## M√©triques de qualit√©

| M√©trique | Description | Cible |
|----------|-------------|-------|
| **Score moyen** | Qualit√© moyenne des cartes | > 8.0/10 |
| **Taux d'approbation** | Cartes approuv√©es du premier coup | > 70% |
| **Doublons d√©tect√©s** | Cartes similaires identifi√©es | < 5% |
| **Couverture sujet** | % du contenu couvert | > 85% |
| **Diversit√© types** | √âquilibre entre les types | Selon config |

---

## Structure du code

<FileTree>
- src/
  - graphs/
    - **card_generator.py** üé¥ Graph principal
  - nodes/
    - card_generation/
      - validate_inputs.py
      - select_chunks.py
      - planner.py
      - generator.py
      - critic.py
      - refiner.py
      - finalizer.py
  - models/
    - **card_types.py** Types de cartes
    - **agent_types.py** Types agent
  - prompts/
    - planner.yaml
    - generator.yaml
    - critic.yaml
    - refiner.yaml
</FileTree>

---

*G√©n√©ration intelligente de cartes d'apprentissage gr√¢ce √† une architecture agentic.*
